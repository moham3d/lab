<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nursing Assessment Form - Healthcare Patient Management</title>
    <link href="/styles/main.css" rel="stylesheet">
    <script defer src="/vendor/alpine.min.js"></script>
    <script defer src="/vendor/htmx.min.js"></script>
    <script defer src="/src/js/main.js"></script>
</head>
<body class="h-full bg-gray-50" x-data="nursingAssessment">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <svg class="h-8 w-8 text-primary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                        <span class="ml-2 text-xl font-semibold text-gray-900">Healthcare Portal</span>
                    </div>
                    <div class="ml-10 flex space-x-8">
                        <a href="/dashboard" class="text-gray-500 hover:text-gray-700 px-3 py-2 rounded-md text-sm font-medium">Dashboard</a>
                        <a href="/patients" class="text-gray-500 hover:text-gray-700 px-3 py-2 rounded-md text-sm font-medium">Patients</a>
                        <a href="/visits" class="text-gray-500 hover:text-gray-700 px-3 py-2 rounded-md text-sm font-medium">Visits</a>
                        <a href="/forms-nursing" class="text-blue-600 border-b-2 border-blue-600 px-3 py-2 text-sm font-medium">Forms</a>
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <!-- User Menu -->
                    <div class="relative" x-data="{ open: false }">
                        <button @click="open = !open" class="flex items-center text-sm rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                            <span class="sr-only">Open user menu</span>
                            <div class="h-8 w-8 rounded-full bg-primary-600 flex items-center justify-center">
                                <span class="text-sm font-medium text-white">U</span>
                            </div>
                            <span class="ml-2 text-gray-700 text-sm font-medium">User</span>
                            <svg class="ml-1 h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>

                        <div x-show="open" @click.away="open = false" class="absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5">
                            <div class="py-1">
                                <button @click="$store.auth.logout()" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Sign out</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div class="px-4 py-6 sm:px-0">
            <!-- Page Header -->
            <div class="mb-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Nursing Assessment Form</h1>
                        <p class="mt-1 text-sm text-gray-600">
                            Complete patient nursing assessment with vital signs validation.
                        </p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-sm text-gray-500">
                            <span x-show="lastSaved" x-text="`Last saved: ${formatTime(lastSaved)}`"></span>
                            <span x-show="!lastSaved">Not saved</span>
                        </div>
                        <a href="/visits" class="btn-secondary">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                            </svg>
                            Back to Visits
                        </a>
                    </div>
                </div>
            </div>

            <!-- Patient Information Card -->
            <div class="bg-white shadow rounded-lg mb-6" x-show="patient">
                <div class="px-4 py-5 sm:p-6">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Patient Information</h3>
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Name</dt>
                            <dd class="mt-1 text-sm text-gray-900" x-text="patient?.full_name"></dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">SSN</dt>
                            <dd class="mt-1 text-sm text-gray-900" x-text="patient?.ssn"></dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Age</dt>
                            <dd class="mt-1 text-sm text-gray-900" x-text="calculateAge(patient?.date_of_birth)"></dd>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Assessment Form -->
            <div class="bg-white shadow rounded-lg">
                <form @submit.prevent="submitAssessment()" class="px-4 py-5 sm:p-6">
                    <!-- Progress Indicator -->
                    <div class="mb-8">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-lg font-medium text-gray-900">Assessment Progress</h3>
                            <span class="text-sm text-gray-500" x-text="`${calculateProgress()}% Complete`"></span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-primary-600 h-2 rounded-full transition-all duration-300" :style="`width: ${calculateProgress()}%`"></div>
                        </div>
                    </div>

                    <!-- Tab Navigation -->
                    <div class="border-b border-gray-200 mb-6">
                        <nav class="-mb-px flex space-x-8">
                            <button type="button" @click="activeTab = 'basic'" :class="{ 'border-primary-500 text-primary-600': activeTab === 'basic', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'basic' }" class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                                Basic Information
                            </button>
                            <button type="button" @click="activeTab = 'vitals'" :class="{ 'border-primary-500 text-primary-600': activeTab === 'vitals', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'vitals' }" class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                                Vital Signs
                            </button>
                            <button type="button" @click="activeTab = 'assessment'" :class="{ 'border-primary-500 text-primary-600': activeTab === 'assessment', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'assessment' }" class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                                Clinical Assessment
                            </button>
                        </nav>
                    </div>

                    <!-- Basic Information Tab -->
                    <div x-show="activeTab === 'basic'" class="space-y-6">
                        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                            <!-- Mode of Arrival -->
                            <div class="form-group">
                                <label for="mode_of_arrival" class="label">Mode of Arrival *</label>
                                <select
                                    id="mode_of_arrival"
                                    x-model="form.mode_of_arrival"
                                    class="input-field"
                                    required
                                >
                                    <option value="">Select mode</option>
                                    <option value="walk">Walking</option>
                                    <option value="ambulatory">Ambulatory</option>
                                    <option value="wheelchair">Wheelchair</option>
                                    <option value="stretcher">Stretcher</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>

                            <!-- Chief Complaint -->
                            <div class="form-group">
                                <label for="chief_complaint" class="label">Chief Complaint *</label>
                                <textarea
                                    id="chief_complaint"
                                    x-model="form.chief_complaint"
                                    rows="3"
                                    class="input-field"
                                    placeholder="Patient's primary concern or complaint"
                                    required
                                ></textarea>
                            </div>

                            <!-- Accompanied By -->
                            <div class="form-group">
                                <label for="accompanied_by" class="label">Accompanied By</label>
                                <select
                                    id="accompanied_by"
                                    x-model="form.accompanied_by"
                                    class="input-field"
                                >
                                    <option value="">Select accompaniment</option>
                                    <option value="spouse">Spouse</option>
                                    <option value="relative">Relative</option>
                                    <option value="friend">Friend</option>
                                    <option value="alone">Alone</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>

                            <!-- Language -->
                            <div class="form-group">
                                <label for="language_spoken" class="label">Language Spoken</label>
                                <select
                                    id="language_spoken"
                                    x-model="form.language_spoken"
                                    class="input-field"
                                >
                                    <option value="arabic">Arabic</option>
                                    <option value="english">English</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Vital Signs Tab -->
                    <div x-show="activeTab === 'vitals'" class="space-y-6">
                        <div class="vital-signs-grid">
                            <!-- Temperature -->
                            <div class="form-group">
                                <label for="temperature" class="label">Temperature (°C) *</label>
                                <input
                                    type="number"
                                    id="temperature"
                                    x-model="form.temperature"
                                    @input="validateVitals"
                                    step="0.1"
                                    min="30"
                                    max="45"
                                    class="input-field"
                                    :class="{ 
                                        'border-red-300': form.temperature && !isValidTemperature(form.temperature), 
                                        'border-green-300': form.temperature && isValidTemperature(form.temperature) && isNormalTemperature(form.temperature),
                                        'border-yellow-300': form.temperature && isValidTemperature(form.temperature) && !isNormalTemperature(form.temperature)
                                    }"
                                    placeholder="36.5"
                                    required
                                >
                                <p x-show="form.temperature && !isValidTemperature(form.temperature)" class="error-message">
                                    Temperature must be between 30-45°C
                                </p>
                                <p x-show="form.temperature && isValidTemperature(form.temperature) && isNormalTemperature(form.temperature)" class="success-message">
                                    ✓ Normal range (36.1-37.2°C)
                                </p>
                                <p x-show="form.temperature && isValidTemperature(form.temperature) && !isNormalTemperature(form.temperature)" class="text-yellow-600 text-sm mt-1">
                                    ⚠ Outside normal range
                                </p>
                            </div>

                            <!-- Pulse -->
                            <div class="form-group">
                                <label for="pulse" class="label">Pulse (bpm) *</label>
                                <input
                                    type="number"
                                    id="pulse"
                                    x-model="form.pulse"
                                    @input="validateVitals"
                                    min="30"
                                    max="200"
                                    class="input-field"
                                    :class="{ 
                                        'border-red-300': form.pulse && !isValidPulse(form.pulse), 
                                        'border-green-300': form.pulse && isValidPulse(form.pulse) && isNormalPulse(form.pulse),
                                        'border-yellow-300': form.pulse && isValidPulse(form.pulse) && !isNormalPulse(form.pulse)
                                    }"
                                    placeholder="72"
                                    required
                                >
                                <p x-show="form.pulse && !isValidPulse(form.pulse)" class="error-message">
                                    Pulse must be between 30-200 bpm
                                </p>
                                <p x-show="form.pulse && isValidPulse(form.pulse) && isNormalPulse(form.pulse)" class="success-message">
                                    ✓ Normal range (60-100 bpm)
                                </p>
                                <p x-show="form.pulse && isValidPulse(form.pulse) && !isNormalPulse(form.pulse)" class="text-yellow-600 text-sm mt-1">
                                    ⚠ Outside normal range
                                </p>
                            </div>

                            <!-- Blood Pressure Systolic -->
                            <div class="form-group">
                                <label for="blood_pressure_systolic" class="label">Blood Pressure Systolic (mmHg) *</label>
                                <input
                                    type="number"
                                    id="blood_pressure_systolic"
                                    x-model="form.blood_pressure_systolic"
                                    @input="validateVitals"
                                    min="70"
                                    max="250"
                                    class="input-field"
                                    :class="{ 
                                        'border-red-300': form.blood_pressure_systolic && !isValidSystolic(form.blood_pressure_systolic), 
                                        'border-green-300': form.blood_pressure_systolic && isValidSystolic(form.blood_pressure_systolic) && isNormalSystolic(form.blood_pressure_systolic),
                                        'border-yellow-300': form.blood_pressure_systolic && isValidSystolic(form.blood_pressure_systolic) && !isNormalSystolic(form.blood_pressure_systolic)
                                    }"
                                    placeholder="120"
                                    required
                                >
                                <p x-show="form.blood_pressure_systolic && !isValidSystolic(form.blood_pressure_systolic)" class="error-message">
                                    Systolic BP must be between 70-250 mmHg
                                </p>
                                <p x-show="form.blood_pressure_systolic && isValidSystolic(form.blood_pressure_systolic) && isNormalSystolic(form.blood_pressure_systolic)" class="success-message">
                                    ✓ Normal range (90-140 mmHg)
                                </p>
                                <p x-show="form.blood_pressure_systolic && isValidSystolic(form.blood_pressure_systolic) && !isNormalSystolic(form.blood_pressure_systolic)" class="text-yellow-600 text-sm mt-1">
                                    ⚠ Outside normal range
                                </p>
                            </div>

                            <!-- Blood Pressure Diastolic -->
                            <div class="form-group">
                                <label for="blood_pressure_diastolic" class="label">Blood Pressure Diastolic (mmHg) *</label>
                                <input
                                    type="number"
                                    id="blood_pressure_diastolic"
                                    x-model="form.blood_pressure_diastolic"
                                    @input="validateVitals"
                                    min="40"
                                    max="150"
                                    class="input-field"
                                    :class="{ 
                                        'border-red-300': form.blood_pressure_diastolic && !isValidDiastolic(form.blood_pressure_diastolic), 
                                        'border-green-300': form.blood_pressure_diastolic && isValidDiastolic(form.blood_pressure_diastolic) && isNormalDiastolic(form.blood_pressure_diastolic),
                                        'border-yellow-300': form.blood_pressure_diastolic && isValidDiastolic(form.blood_pressure_diastolic) && !isNormalDiastolic(form.blood_pressure_diastolic)
                                    }"
                                    placeholder="80"
                                    required
                                >
                                <p x-show="form.blood_pressure_diastolic && !isValidDiastolic(form.blood_pressure_diastolic)" class="error-message">
                                    Diastolic BP must be between 40-150 mmHg
                                </p>
                                <p x-show="form.blood_pressure_diastolic && isValidDiastolic(form.blood_pressure_diastolic) && isNormalDiastolic(form.blood_pressure_diastolic)" class="success-message">
                                    ✓ Normal range (60-90 mmHg)
                                </p>
                                <p x-show="form.blood_pressure_diastolic && isValidDiastolic(form.blood_pressure_diastolic) && !isNormalDiastolic(form.blood_pressure_diastolic)" class="text-yellow-600 text-sm mt-1">
                                    ⚠ Outside normal range
                                </p>
                            </div>

                            <!-- Respiratory Rate -->
                            <div class="form-group">
                                <label for="respiratory_rate" class="label">Respiratory Rate (breaths/min) *</label>
                                <input
                                    type="number"
                                    id="respiratory_rate"
                                    x-model="form.respiratory_rate"
                                    @input="validateVitals"
                                    min="8"
                                    max="40"
                                    class="input-field"
                                    :class="{ 
                                        'border-red-300': form.respiratory_rate && !isValidRespiratoryRate(form.respiratory_rate), 
                                        'border-green-300': form.respiratory_rate && isValidRespiratoryRate(form.respiratory_rate) && isNormalRespiratoryRate(form.respiratory_rate),
                                        'border-yellow-300': form.respiratory_rate && isValidRespiratoryRate(form.respiratory_rate) && !isNormalRespiratoryRate(form.respiratory_rate)
                                    }"
                                    placeholder="16"
                                    required
                                >
                                <p x-show="form.respiratory_rate && !isValidRespiratoryRate(form.respiratory_rate)" class="error-message">
                                    Respiratory rate must be between 8-40 breaths/min
                                </p>
                                <p x-show="form.respiratory_rate && isValidRespiratoryRate(form.respiratory_rate) && isNormalRespiratoryRate(form.respiratory_rate)" class="success-message">
                                    ✓ Normal range (12-20 breaths/min)
                                </p>
                                <p x-show="form.respiratory_rate && isValidRespiratoryRate(form.respiratory_rate) && !isNormalRespiratoryRate(form.respiratory_rate)" class="text-yellow-600 text-sm mt-1">
                                    ⚠ Outside normal range
                                </p>
                            </div>

                            <!-- Oxygen Saturation -->
                            <div class="form-group">
                                <label for="oxygen_saturation" class="label">Oxygen Saturation (%)</label>
                                <input
                                    type="number"
                                    id="oxygen_saturation"
                                    x-model="form.oxygen_saturation"
                                    @input="validateVitals"
                                    min="70"
                                    max="100"
                                    class="input-field"
                                    :class="{ 
                                        'border-red-300': form.oxygen_saturation && !isValidOxygenSaturation(form.oxygen_saturation), 
                                        'border-green-300': form.oxygen_saturation && isValidOxygenSaturation(form.oxygen_saturation) && isNormalOxygenSaturation(form.oxygen_saturation),
                                        'border-yellow-300': form.oxygen_saturation && isValidOxygenSaturation(form.oxygen_saturation) && !isNormalOxygenSaturation(form.oxygen_saturation)
                                    }"
                                    placeholder="98"
                                >
                                <p x-show="form.oxygen_saturation && !isValidOxygenSaturation(form.oxygen_saturation)" class="error-message">
                                    Oxygen saturation must be between 70-100%
                                </p>
                                <p x-show="form.oxygen_saturation && isValidOxygenSaturation(form.oxygen_saturation) && isNormalOxygenSaturation(form.oxygen_saturation)" class="success-message">
                                    ✓ Normal range (95-100%)
                                </p>
                                <p x-show="form.oxygen_saturation && isValidOxygenSaturation(form.oxygen_saturation) && !isNormalOxygenSaturation(form.oxygen_saturation)" class="text-yellow-600 text-sm mt-1">
                                    ⚠ Outside normal range
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Clinical Assessment Tab -->
                    <div x-show="activeTab === 'assessment'" class="space-y-6">
                        <div class="grid grid-cols-1 gap-6">
                            <!-- Pain Assessment -->
                            <div class="form-group">
                                <label for="pain_scale" class="label">Pain Scale (0-10)</label>
                                <div class="flex items-center space-x-4">
                                    <input
                                        type="range"
                                        id="pain_scale"
                                        x-model="form.pain_scale"
                                        min="0"
                                        max="10"
                                        class="flex-1"
                                    >
                                    <span class="text-lg font-medium text-gray-900 min-w-0" x-text="form.pain_scale || 0"></span>
                                </div>
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>No Pain</span>
                                    <span>Severe Pain</span>
                                </div>
                            </div>

                            <!-- General Appearance -->
                            <div class="form-group">
                                <label for="general_appearance" class="label">General Appearance</label>
                                <textarea
                                    id="general_appearance"
                                    x-model="form.general_appearance"
                                    rows="3"
                                    class="input-field"
                                    placeholder="Describe patient's general appearance, alertness, distress level"
                                ></textarea>
                            </div>

                            <!-- Allergies -->
                            <div class="form-group">
                                <label for="allergies" class="label">Known Allergies</label>
                                <textarea
                                    id="allergies"
                                    x-model="form.allergies"
                                    rows="2"
                                    class="input-field"
                                    placeholder="List any known allergies or NKDA"
                                ></textarea>
                            </div>

                            <!-- Current Medications -->
                            <div class="form-group">
                                <label for="current_medications" class="label">Current Medications</label>
                                <textarea
                                    id="current_medications"
                                    x-model="form.current_medications"
                                    rows="3"
                                    class="input-field"
                                    placeholder="List current medications with dosage"
                                ></textarea>
                            </div>

                            <!-- Assessment Notes -->
                            <div class="form-group">
                                <label for="assessment_notes" class="label">Assessment Notes</label>
                                <textarea
                                    id="assessment_notes"
                                    x-model="form.assessment_notes"
                                    rows="4"
                                    class="input-field"
                                    placeholder="Additional clinical observations and assessment notes"
                                ></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="mt-8 pt-6 border-t border-gray-200 flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center">
                                <input
                                    type="checkbox"
                                    id="auto_save"
                                    x-model="autoSave"
                                    class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"
                                >
                                <label for="auto_save" class="ml-2 block text-sm text-gray-900">
                                    Auto-save every 30 seconds
                                </label>
                            </div>
                            <button type="button" @click="saveDraft()" class="text-sm text-primary-600 hover:text-primary-500">
                                Save Draft
                            </button>
                        </div>

                        <div class="flex space-x-3">
                            <button type="button" @click="window.location.href='/visits'" class="btn-secondary">
                                Cancel
                            </button>
                            <button type="submit" :disabled="loading || !isFormValid()" class="btn-primary">
                                <span x-show="loading" class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></span>
                                <span x-text="loading ? 'Saving...' : 'Complete Assessment'"></span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Success/Error Messages -->
            <div x-show="successMessage" x-text="successMessage" class="mt-6 p-4 bg-green-50 border border-green-200 text-green-700 rounded-md fade-in"></div>
            <div x-show="errorMessage" x-text="errorMessage" class="mt-6 p-4 bg-red-50 border border-red-200 text-red-700 rounded-md fade-in"></div>
        </div>
    </main>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('nursingAssessment', () => ({
                activeTab: 'basic',
                patient: null,
                form: {
                    // Basic Information
                    mode_of_arrival: '',
                    chief_complaint: '',
                    accompanied_by: '',
                    language_spoken: 'arabic',
                    
                    // Vital Signs
                    temperature: '',
                    pulse: '',
                    blood_pressure_systolic: '',
                    blood_pressure_diastolic: '',
                    respiratory_rate: '',
                    oxygen_saturation: '',
                    
                    // Clinical Assessment
                    pain_scale: 0,
                    general_appearance: '',
                    allergies: '',
                    current_medications: '',
                    assessment_notes: ''
                },
                loading: false,
                autoSave: true,
                lastSaved: null,
                successMessage: '',
                errorMessage: '',
                autoSaveTimer: null,
                visitId: null,

                init() {
                    // Get visit ID from URL params or other source
                    this.visitId = this.getUrlParameter('visit_id');
                    
                    if (this.visitId) {
                        this.loadVisitData();
                    }
                    
                    this.loadDraft();
                    this.setupAutoSave();
                },

                getUrlParameter(name) {
                    const urlParams = new URLSearchParams(window.location.search);
                    return urlParams.get(name);
                },

                async loadVisitData() {
                    try {
                        const response = await fetch(`/api/visits/${this.visitId}`, {
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('auth_token')}`,
                            },
                        });

                        if (response.ok) {
                            const visit = await response.json();
                            this.patient = visit.patient;
                        }
                    } catch (error) {
                        console.error('Failed to load visit data:', error);
                    }
                },

                setupAutoSave() {
                    this.$watch('form', () => {
                        if (this.autoSave) {
                            this.scheduleAutoSave();
                        }
                    }, { deep: true });
                },

                scheduleAutoSave() {
                    if (this.autoSaveTimer) {
                        clearTimeout(this.autoSaveTimer);
                    }
                    
                    this.autoSaveTimer = setTimeout(() => {
                        this.saveDraft();
                    }, 30000); // Auto-save every 30 seconds
                },

                calculateAge(birthDate) {
                    if (!birthDate) return 'N/A';
                    
                    const birth = new Date(birthDate);
                    const today = new Date();
                    let age = today.getFullYear() - birth.getFullYear();
                    const monthDiff = today.getMonth() - birth.getMonth();
                    
                    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                        age--;
                    }
                    
                    return `${age} years`;
                },

                calculateProgress() {
                    const requiredFields = [
                        'mode_of_arrival', 'chief_complaint', 
                        'temperature', 'pulse', 'blood_pressure_systolic', 'blood_pressure_diastolic', 'respiratory_rate'
                    ];
                    
                    const completedFields = requiredFields.filter(field => this.form[field] && this.form[field] !== '');
                    return Math.round((completedFields.length / requiredFields.length) * 100);
                },

                formatTime(timestamp) {
                    if (!timestamp) return '';
                    return new Date(timestamp).toLocaleTimeString();
                },

                // Vital Signs Validation Functions
                isValidTemperature(temp) {
                    return temp >= 30 && temp <= 45;
                },

                isNormalTemperature(temp) {
                    return temp >= 36.1 && temp <= 37.2;
                },

                isValidPulse(pulse) {
                    return pulse >= 30 && pulse <= 200;
                },

                isNormalPulse(pulse) {
                    return pulse >= 60 && pulse <= 100;
                },

                isValidSystolic(systolic) {
                    return systolic >= 70 && systolic <= 250;
                },

                isNormalSystolic(systolic) {
                    return systolic >= 90 && systolic <= 140;
                },

                isValidDiastolic(diastolic) {
                    return diastolic >= 40 && diastolic <= 150;
                },

                isNormalDiastolic(diastolic) {
                    return diastolic >= 60 && diastolic <= 90;
                },

                isValidRespiratoryRate(rate) {
                    return rate >= 8 && rate <= 40;
                },

                isNormalRespiratoryRate(rate) {
                    return rate >= 12 && rate <= 20;
                },

                isValidOxygenSaturation(sat) {
                    return sat >= 70 && sat <= 100;
                },

                isNormalOxygenSaturation(sat) {
                    return sat >= 95 && sat <= 100;
                },

                validateVitals() {
                    // This function is called on input to provide real-time validation feedback
                    // The validation logic is already handled by the individual validation functions
                },

                isFormValid() {
                    const requiredFieldsFilled = this.form.mode_of_arrival && 
                                                 this.form.chief_complaint && 
                                                 this.form.temperature && 
                                                 this.form.pulse && 
                                                 this.form.blood_pressure_systolic && 
                                                 this.form.blood_pressure_diastolic && 
                                                 this.form.respiratory_rate;

                    const vitalsValid = this.isValidTemperature(this.form.temperature) &&
                                        this.isValidPulse(this.form.pulse) &&
                                        this.isValidSystolic(this.form.blood_pressure_systolic) &&
                                        this.isValidDiastolic(this.form.blood_pressure_diastolic) &&
                                        this.isValidRespiratoryRate(this.form.respiratory_rate) &&
                                        (!this.form.oxygen_saturation || this.isValidOxygenSaturation(this.form.oxygen_saturation));

                    return requiredFieldsFilled && vitalsValid;
                },

                saveDraft() {
                    try {
                        const draftKey = this.visitId ? `nursing_assessment_${this.visitId}` : 'nursing_assessment_draft';
                        localStorage.setItem(draftKey, JSON.stringify(this.form));
                        this.lastSaved = new Date();
                    } catch (error) {
                        console.error('Failed to save draft:', error);
                    }
                },

                loadDraft() {
                    try {
                        const draftKey = this.visitId ? `nursing_assessment_${this.visitId}` : 'nursing_assessment_draft';
                        const draft = localStorage.getItem(draftKey);
                        if (draft) {
                            const draftData = JSON.parse(draft);
                            Object.assign(this.form, draftData);
                        }
                    } catch (error) {
                        console.error('Failed to load draft:', error);
                    }
                },

                clearDraft() {
                    try {
                        const draftKey = this.visitId ? `nursing_assessment_${this.visitId}` : 'nursing_assessment_draft';
                        localStorage.removeItem(draftKey);
                    } catch (error) {
                        console.error('Failed to clear draft:', error);
                    }
                },

                async submitAssessment() {
                    if (!this.isFormValid()) {
                        this.errorMessage = 'Please complete all required fields and fix validation errors.';
                        setTimeout(() => this.errorMessage = '', 5000);
                        return;
                    }

                    this.loading = true;
                    this.errorMessage = '';
                    this.successMessage = '';

                    try {
                        const assessmentData = {
                            ...this.form,
                            visit_id: this.visitId,
                            assessed_at: new Date().toISOString()
                        };

                        const response = await fetch('/api/assessments/nursing', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                            },
                            body: JSON.stringify(assessmentData)
                        });

                        if (response.ok) {
                            this.successMessage = 'Nursing assessment completed successfully!';
                            this.clearDraft();
                            
                            // Redirect after success
                            setTimeout(() => {
                                window.location.href = this.visitId ? `/visits/${this.visitId}` : '/visits';
                            }, 2000);
                        } else if (response.status === 401) {
                            window.location.href = '/login';
                        } else {
                            const errorData = await response.json();
                            this.errorMessage = errorData.detail || 'Failed to submit assessment. Please try again.';
                        }
                    } catch (error) {
                        console.error('Assessment submission error:', error);
                        this.errorMessage = 'Network error. Please check your connection and try again.';
                    } finally {
                        this.loading = false;
                    }
                }
            }));
        });
    </script>
</body>
</html>