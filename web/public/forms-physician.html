<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physician Assessment - Patient Visit Management</title>
    <link href="https://cdn.tailwindcss.com" rel="stylesheet">
    <script src="vendor/alpine.min.js" defer></script>
    <script src="vendor/htmx.min.js"></script>
    <link href="styles/main.css" rel="stylesheet">
</head>
<body class="bg-gray-50" x-data="physicianForm()" x-init="init()">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <h1 class="text-2xl font-bold text-gray-900">Physician Assessment</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <a href="dashboard.html" class="text-gray-600 hover:text-gray-900">← Back to Dashboard</a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="px-4 py-6 sm:px-0">
                <!-- Patient Info -->
                <div class="bg-white shadow rounded-lg mb-6" x-show="patientInfo">
                    <div class="px-4 py-5 sm:p-6">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Patient Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Full Name</label>
                                <p class="mt-1 text-sm text-gray-900" x-text="patientInfo?.full_name_arabic || 'N/A'"></p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Medical Number</label>
                                <p class="mt-1 text-sm text-gray-900" x-text="patientInfo?.medical_number || 'N/A'"></p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Mobile</label>
                                <p class="mt-1 text-sm text-gray-900" x-text="patientInfo?.mobile || 'N/A'"></p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Date of Birth</label>
                                <p class="mt-1 text-sm text-gray-900" x-text="patientInfo?.date_of_birth || 'N/A'"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Assessment Form -->
                <div class="bg-white shadow rounded-lg">
                    <form @submit.prevent="submitAssessment()" class="px-4 py-5 sm:p-6">
                        <!-- Study Information -->
                        <div class="mb-8">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Study Information</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="study_reason" class="block text-sm font-medium text-gray-700">Why do you do the study? (سبب إجراء الفحص)</label>
                                    <textarea id="study_reason" x-model="form.study_reason" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Enter the reason for the study..."></textarea>
                                </div>
                                <div>
                                    <label for="gypsum_splint" class="block text-sm font-medium text-gray-700">Is there a gypsum splint in the radiology workplace? (جبيرة جبس)</label>
                                    <select id="gypsum_splint" x-model="form.gypsum_splint" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        <option value="">Select...</option>
                                        <option value="yes">Yes (نعم)</option>
                                        <option value="no">No (لا)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Medical History -->
                        <div class="mb-8">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Medical History</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="chronic_disease" class="block text-sm font-medium text-gray-700">Do you have any chronic disease? (أمراض مزمنة)</label>
                                    <select id="chronic_disease" x-model="form.chronic_disease" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        <option value="">Select...</option>
                                        <option value="yes">Yes (نعم)</option>
                                        <option value="no">No (لا)</option>
                                    </select>
                                    <input x-show="form.chronic_disease === 'yes'" x-model="form.chronic_disease_details" type="text" class="mt-2 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Specify chronic diseases...">
                                </div>
                                <div>
                                    <label for="pacemaker" class="block text-sm font-medium text-gray-700">Do you have pacemaker? (جهاز منظم ضربات القلب)</label>
                                    <select id="pacemaker" x-model="form.pacemaker" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        <option value="">Select...</option>
                                        <option value="yes">Yes (نعم)</option>
                                        <option value="no">No (لا)</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="implants" class="block text-sm font-medium text-gray-700">Have slats - screws - artificial joints been installed? (شرائح - مسامير - مفاصل صناعية)</label>
                                    <select id="implants" x-model="form.implants" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        <option value="">Select...</option>
                                        <option value="yes">Yes (نعم)</option>
                                        <option value="no">No (لا)</option>
                                    </select>
                                    <input x-show="form.implants === 'yes'" x-model="form.implants_details" type="text" class="mt-2 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Specify implants...">
                                </div>
                                <div>
                                    <label for="pregnancy" class="block text-sm font-medium text-gray-700">Is there pregnancy? (حمل)</label>
                                    <select id="pregnancy" x-model="form.pregnancy" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        <option value="">Select...</option>
                                        <option value="yes">Yes (نعم)</option>
                                        <option value="no">No (لا)</option>
                                        <option value="not_applicable">Not Applicable (غير قابل)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Symptoms -->
                        <div class="mb-8">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Symptoms</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="pain_numbness" class="block text-sm font-medium text-gray-700">Do you have any pain - numbness? (ألم - تنميل)</label>
                                    <select id="pain_numbness" x-model="form.pain_numbness" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        <option value="">Select...</option>
                                        <option value="yes">Yes (نعم)</option>
                                        <option value="no">No (لا)</option>
                                    </select>
                                    <div x-show="form.pain_numbness === 'yes'" class="mt-2 space-y-2">
                                        <input x-model="form.pain_location" type="text" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Location and extent...">
                                        <input x-model="form.pain_duration" type="text" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Duration and time...">
                                    </div>
                                </div>
                                <div>
                                    <label for="spinal_deformities" class="block text-sm font-medium text-gray-700">Do you have spinal deformities or warps? (تشوهات العمود الفقري)</label>
                                    <select id="spinal_deformities" x-model="form.spinal_deformities" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        <option value="">Select...</option>
                                        <option value="yes">Yes (نعم)</option>
                                        <option value="no">No (لا)</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="swelling" class="block text-sm font-medium text-gray-700">Do you have any swelling? (تورم)</label>
                                    <select id="swelling" x-model="form.swelling" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        <option value="">Select...</option>
                                        <option value="yes">Yes (نعم)</option>
                                        <option value="no">No (لا)</option>
                                    </select>
                                    <input x-show="form.swelling === 'yes'" x-model="form.swelling_location" type="text" class="mt-2 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Location of swelling...">
                                </div>
                                <div>
                                    <label for="brain_scan" class="block text-sm font-medium text-gray-700">Brain scan condition (فحص المخ)</label>
                                    <div class="mt-2 space-y-2">
                                        <div>
                                            <label for="headache" class="inline-flex items-center">
                                                <input id="headache" x-model="form.headache" type="checkbox" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                                <span class="ml-2">Headache (صداع)</span>
                                            </label>
                                        </div>
                                        <div>
                                            <label for="vision_problems" class="inline-flex items-center">
                                                <input id="vision_problems" x-model="form.vision_problems" type="checkbox" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                                <span class="ml-2">Vision problems (مشاكل في النظر)</span>
                                            </label>
                                        </div>
                                        <div>
                                            <label for="hearing_problems" class="inline-flex items-center">
                                                <input id="hearing_problems" x-model="form.hearing_problems" type="checkbox" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                                <span class="ml-2">Hearing problems (مشاكل في السمع)</span>
                                            </label>
                                        </div>
                                        <div>
                                            <label for="imbalance" class="inline-flex items-center">
                                                <input id="imbalance" x-model="form.imbalance" type="checkbox" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                                <span class="ml-2">Imbalance (عدم إتزان)</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Medical Info -->
                        <div class="mb-8">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Additional Information</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="fever" class="block text-sm font-medium text-gray-700">Do you have fever? (ارتفاع درجة الحرارة)</label>
                                    <select id="fever" x-model="form.fever" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        <option value="">Select...</option>
                                        <option value="yes">Yes (نعم)</option>
                                        <option value="no">No (لا)</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="previous_operations" class="block text-sm font-medium text-gray-700">Do you perform any operation? (عمليات سابقة)</label>
                                    <select id="previous_operations" x-model="form.previous_operations" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        <option value="">Select...</option>
                                        <option value="yes">Yes (نعم)</option>
                                        <option value="no">No (لا)</option>
                                    </select>
                                    <div x-show="form.previous_operations === 'yes'" class="mt-2 space-y-2">
                                        <input x-model="form.operation_date" type="date" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Select operation date">
                                        <input x-model="form.operation_reason" type="text" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Reason for operation...">
                                    </div>
                                </div>
                                <div>
                                    <label for="tumor_history" class="block text-sm font-medium text-gray-700">Do you have any history of tumors? (تاريخ أورام)</label>
                                    <select id="tumor_history" x-model="form.tumor_history" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        <option value="">Select...</option>
                                        <option value="yes">Yes (نعم)</option>
                                        <option value="no">No (لا)</option>
                                    </select>
                                    <div x-show="form.tumor_history === 'yes'" class="mt-2 space-y-2">
                                        <input x-model="form.tumor_location" type="text" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Tumor location...">
                                        <input x-model="form.tumor_type" type="text" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Tumor type...">
                                    </div>
                                </div>
                                <div>
                                    <label for="previous_radiology" class="block text-sm font-medium text-gray-700">Do you have previous investigation? (فحوصات أشعة سابقة)</label>
                                    <select id="previous_radiology" x-model="form.previous_radiology" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        <option value="">Select...</option>
                                        <option value="yes">Yes (نعم)</option>
                                        <option value="no">No (لا)</option>
                                    </select>
                                    <div x-show="form.previous_radiology === 'yes'" class="mt-2 space-y-2">
                                        <input x-model="form.previous_radiology_type" type="text" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Type of radiology...">
                                        <input x-model="form.previous_radiology_date" type="date" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Select radiology date">
                                    </div>
                                </div>
                                <div>
                                    <label for="disc_slip" class="block text-sm font-medium text-gray-700">Do you have previous disc? (انزالق غضروفي)</label>
                                    <select id="disc_slip" x-model="form.disc_slip" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        <option value="">Select...</option>
                                        <option value="yes">Yes (نعم)</option>
                                        <option value="no">No (لا)</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="drowsiness_medication" class="block text-sm font-medium text-gray-700">Medication in increase fall risk (أدوية تسبب نعاس)</label>
                                    <textarea x-model="form.drowsiness_medication" rows="2" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="List medications that cause drowsiness..."></textarea>
                                </div>
                                <div>
                                    <label for="current_medication" class="block text-sm font-medium text-gray-700">Current medication (أدوية حالية)</label>
                                    <textarea x-model="form.current_medication" rows="2" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="List current medications..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Technical Parameters -->
                        <div class="mb-8">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Technical Parameters</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <label for="dlp" class="block text-sm font-medium text-gray-700">DLP</label>
                                    <input id="dlp" x-model="form.dlp" type="text" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="ctd1vol" class="block text-sm font-medium text-gray-700">CTD1vol</label>
                                    <input id="ctd1vol" x-model="form.ctd1vol" type="text" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="mas" class="block text-sm font-medium text-gray-700">MAs</label>
                                    <input id="mas" x-model="form.mas" type="text" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="kv" class="block text-sm font-medium text-gray-700">KV</label>
                                    <input id="kv" x-model="form.kv" type="text" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                            </div>
                        </div>

                        <!-- Diagnosis -->
                        <div class="mb-8">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Diagnosis</h3>
                            <div>
                                <label for="diagnosis" class="block text-sm font-medium text-gray-700">Diagnosis (التشخيص)</label>
                                <textarea id="diagnosis" x-model="form.diagnosis" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Enter diagnosis..."></textarea>
                            </div>
                        </div>

                        <!-- Signatures -->
                        <div class="mb-8">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Signatures</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Patient Signature -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Patient Signature (توقيع المريض)</label>
                                    <canvas id="patientSignatureCanvas" class="border border-gray-300 rounded-md w-full h-32 bg-white"></canvas>
                                    <div class="mt-2 flex space-x-2">
                                        <button type="button" @click="clearPatientSignature()" class="px-3 py-1 text-sm text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">Clear</button>
                                    </div>
                                </div>
                                <!-- Physician Signature -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Physician Signature (توقيع الطبيب)</label>
                                    <canvas id="physicianSignatureCanvas" class="border border-gray-300 rounded-md w-full h-32 bg-white"></canvas>
                                    <div class="mt-2 flex space-x-2">
                                        <button type="button" @click="clearPhysicianSignature()" class="px-3 py-1 text-sm text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">Clear</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="flex justify-end">
                            <button type="submit" :disabled="loading" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50">
                                <span x-show="!loading">Complete Assessment</span>
                                <span x-show="loading" x-text="loadingText"></span>
                            </button>
                        </div>

                        <!-- Messages -->
                        <div x-show="errorMessage" class="mt-4 p-4 bg-red-50 border border-red-200 rounded-md">
                            <p class="text-sm text-red-600" x-text="errorMessage"></p>
                        </div>
                        <div x-show="successMessage" class="mt-4 p-4 bg-green-50 border border-green-200 rounded-md">
                            <p class="text-sm text-green-600" x-text="successMessage"></p>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script>
        function physicianForm() {
            return {
                visitId: null,
                patientInfo: null,
                loading: false,
                loadingText: 'Submitting...',
                errorMessage: '',
                successMessage: '',
                form: {
                    // Study info
                    study_reason: '',
                    gypsum_splint: '',
                    
                    // Medical history
                    chronic_disease: '',
                    chronic_disease_details: '',
                    pacemaker: '',
                    implants: '',
                    implants_details: '',
                    pregnancy: '',
                    
                    // Symptoms
                    pain_numbness: '',
                    pain_location: '',
                    pain_duration: '',
                    spinal_deformities: '',
                    swelling: '',
                    swelling_location: '',
                    headache: false,
                    vision_problems: false,
                    hearing_problems: false,
                    imbalance: false,
                    
                    // Additional info
                    fever: '',
                    previous_operations: '',
                    operation_date: '',
                    operation_reason: '',
                    tumor_history: '',
                    tumor_location: '',
                    tumor_type: '',
                    previous_radiology: '',
                    previous_radiology_type: '',
                    previous_radiology_date: '',
                    disc_slip: '',
                    drowsiness_medication: '',
                    current_medication: '',
                    
                    // Technical parameters
                    dlp: '',
                    ctd1vol: '',
                    mas: '',
                    kv: '',
                    
                    // Diagnosis
                    diagnosis: '',
                    
                    // Signatures
                    patient_signature: '',
                    physician_signature: ''
                },

                init() {
                    this.visitId = this.getUrlParameter('visit_id');
                    
                    if (this.visitId) {
                        this.loadVisitData();
                    }
                    
                    this.loadDraft();
                    this.setupAutoSave();
                    this.initPatientSignaturePad();
                    this.initPhysicianSignaturePad();
                },

                getUrlParameter(name) {
                    const urlParams = new URLSearchParams(window.location.search);
                    return urlParams.get(name);
                },

                async loadVisitData() {
                    try {
                        const response = await fetch(`/api/visits/${this.visitId}`, {
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('auth_token')}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            const visitData = await response.json();
                            this.patientInfo = visitData.patient;
                            this.form.patient_id = visitData.patient_id;
                            this.form.visit_id = this.visitId;
                        }
                    } catch (error) {
                        console.error('Error loading visit data:', error);
                    }
                },

                loadDraft() {
                    const draft = localStorage.getItem(`physician_draft_${this.visitId}`);
                    if (draft) {
                        try {
                            this.form = { ...this.form, ...JSON.parse(draft) };
                        } catch (error) {
                            console.error('Error loading draft:', error);
                        }
                    }
                },

                setupAutoSave() {
                    setInterval(() => {
                        if (this.visitId) {
                            localStorage.setItem(`physician_draft_${this.visitId}`, JSON.stringify(this.form));
                        }
                    }, 30000); // Auto-save every 30 seconds
                },

                clearDraft() {
                    if (this.visitId) {
                        localStorage.removeItem(`physician_draft_${this.visitId}`);
                    }
                },

                initPatientSignaturePad() {
                    const canvas = document.getElementById('patientSignatureCanvas');
                    const ctx = canvas.getContext('2d');
                    let drawing = false;

                    canvas.addEventListener('mousedown', () => drawing = true);
                    canvas.addEventListener('mouseup', () => drawing = false);
                    canvas.addEventListener('mouseout', () => drawing = false);

                    canvas.addEventListener('mousemove', (e) => {
                        if (!drawing) return;
                        
                        const rect = canvas.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;
                        
                        ctx.lineWidth = 2;
                        ctx.lineCap = 'round';
                        ctx.strokeStyle = '#000';
                        
                        ctx.lineTo(x, y);
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.moveTo(x, y);
                    });

                    // Touch events for mobile/tablet
                    canvas.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        drawing = true;
                        const rect = canvas.getBoundingClientRect();
                        const touch = e.touches[0];
                        const x = touch.clientX - rect.left;
                        const y = touch.clientY - rect.top;
                        ctx.beginPath();
                        ctx.moveTo(x, y);
                    });

                    canvas.addEventListener('touchmove', (e) => {
                        e.preventDefault();
                        if (!drawing) return;
                        
                        const rect = canvas.getBoundingClientRect();
                        const touch = e.touches[0];
                        const x = touch.clientX - rect.left;
                        const y = touch.clientY - rect.top;
                        
                        ctx.lineTo(x, y);
                        ctx.stroke();
                    });

                    canvas.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        drawing = false;
                    });
                },

                initPhysicianSignaturePad() {
                    const canvas = document.getElementById('physicianSignatureCanvas');
                    const ctx = canvas.getContext('2d');
                    let drawing = false;

                    canvas.addEventListener('mousedown', () => drawing = true);
                    canvas.addEventListener('mouseup', () => drawing = false);
                    canvas.addEventListener('mouseout', () => drawing = false);

                    canvas.addEventListener('mousemove', (e) => {
                        if (!drawing) return;
                        
                        const rect = canvas.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;
                        
                        ctx.lineWidth = 2;
                        ctx.lineCap = 'round';
                        ctx.strokeStyle = '#000';
                        
                        ctx.lineTo(x, y);
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.moveTo(x, y);
                    });

                    // Touch events for mobile/tablet
                    canvas.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        drawing = true;
                        const rect = canvas.getBoundingClientRect();
                        const touch = e.touches[0];
                        const x = touch.clientX - rect.left;
                        ctx.beginPath();
                        ctx.moveTo(x, y);
                    });

                    canvas.addEventListener('touchmove', (e) => {
                        e.preventDefault();
                        if (!drawing) return;
                        
                        const rect = canvas.getBoundingClientRect();
                        const touch = e.touches[0];
                        const x = touch.clientX - rect.left;
                        const y = touch.clientY - rect.top;
                        
                        ctx.lineTo(x, y);
                        ctx.stroke();
                    });

                    canvas.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        drawing = false;
                    });
                },

                savePatientSignature() {
                    const canvas = document.getElementById('patientSignatureCanvas');
                    return canvas.toDataURL('image/png');
                },

                savePhysicianSignature() {
                    const canvas = document.getElementById('physicianSignatureCanvas');
                    return canvas.toDataURL('image/png');
                },

                clearPatientSignature() {
                    const canvas = document.getElementById('patientSignatureCanvas');
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                },

                clearPhysicianSignature() {
                    const canvas = document.getElementById('physicianSignatureCanvas');
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                },

                async submitAssessment() {
                    this.loading = true;
                    this.errorMessage = '';
                    this.successMessage = '';

                    try {
                        // Get signature data
                        this.form.patient_signature = this.savePatientSignature();
                        this.form.physician_signature = this.savePhysicianSignature();

                        const assessmentData = {
                            ...this.form,
                            visit_id: this.visitId,
                            assessed_at: new Date().toISOString()
                        };

                        // Check if assessment already exists
                        const existingResponse = await fetch(`/api/forms/general-sheet/${this.visitId}`, {
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('auth_token')}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        let method = 'POST';
                        let url = '/api/forms/general-sheet';

                        if (existingResponse.ok) {
                            const existingData = await existingResponse.json();
                            method = 'PUT';
                            url = `/api/forms/general-sheet/${existingData.radiology_id}`;
                        }

                        const response = await fetch(url, {
                            method: method,
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                            },
                            body: JSON.stringify(assessmentData)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            
                            // Update visit status to 'completed'
                            await this.updateVisitStatus('completed');
                            
                            this.successMessage = 'Physician assessment completed successfully!';
                            this.clearDraft();
                            
                            // Redirect to visit details or dashboard
                            setTimeout(() => {
                                window.location.href = `visits.html`;
                            }, 2000);
                        } else if (response.status === 401) {
                            window.location.href = '/login';
                        } else {
                            const errorData = await response.json();
                            this.errorMessage = errorData.detail || 'Failed to submit assessment. Please try again.';
                        }
                    } catch (error) {
                        console.error('Assessment submission error:', error);
                        this.errorMessage = 'Network error. Please check your connection and try again.';
                    } finally {
                        this.loading = false;
                    }
                },

                async updateVisitStatus(status) {
                    try {
                        const response = await fetch(`/api/visits/${this.visitId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                            },
                            body: JSON.stringify({ visit_status: status })
                        });

                        if (!response.ok) {
                            console.error('Failed to update visit status');
                        }
                    } catch (error) {
                        console.error('Error updating visit status:', error);
                    }
                }
            }
        }
    </script>
</body>
</html>