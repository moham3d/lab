<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Patient - Healthcare Patient Management</title>
    <link href="/styles/main.css" rel="stylesheet">
    <script defer src="/vendor/alpine.min.js"></script>
    <script defer src="/vendor/htmx.min.js"></script>
    <script defer src="/src/js/main.js"></script>
</head>
<body class="h-full bg-gray-50" x-data="patientRegistration">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <svg class="h-8 w-8 text-primary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                        <span class="ml-2 text-xl font-semibold text-gray-900">Healthcare Portal</span>
                    </div>
                    <div class="ml-10 flex space-x-8">
                        <a href="/dashboard" class="text-gray-500 hover:text-gray-700 px-3 py-2 rounded-md text-sm font-medium">Dashboard</a>
                        <a href="/patients" class="text-blue-600 border-b-2 border-blue-600 px-3 py-2 text-sm font-medium">Patients</a>
                        <a href="/visits" class="text-gray-500 hover:text-gray-700 px-3 py-2 rounded-md text-sm font-medium">Visits</a>
                        <a href="/reports" class="text-gray-500 hover:text-gray-700 px-3 py-2 rounded-md text-sm font-medium">Reports</a>
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <!-- User Menu -->
                    <div class="relative" x-data="{ open: false }">
                        <button @click="open = !open" class="flex items-center text-sm rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                            <span class="sr-only">Open user menu</span>
                            <div class="h-8 w-8 rounded-full bg-primary-600 flex items-center justify-center">
                                <span class="text-sm font-medium text-white">U</span>
                            </div>
                            <span class="ml-2 text-gray-700 text-sm font-medium">User</span>
                            <svg class="ml-1 h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>

                        <div x-show="open" @click.away="open = false" class="absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5">
                            <div class="py-1">
                                <button @click="$store.auth.logout()" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Sign out</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div class="px-4 py-6 sm:px-0">
            <!-- Page Header -->
            <div class="mb-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">New Patient Registration</h1>
                        <p class="mt-1 text-sm text-gray-600">
                            Enter patient information with required medical validation.
                        </p>
                    </div>
                    <a href="/patients" class="btn-secondary">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                        Back to Patients
                    </a>
                </div>
            </div>

            <!-- Patient Registration Form -->
            <div class="bg-white shadow rounded-lg">
                <form @submit.prevent="submitForm" class="px-4 py-5 sm:p-6">
                    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                        <!-- Full Name -->
                        <div class="form-group">
                            <label for="full_name" class="label">Full Name *</label>
                            <input
                                type="text"
                                name="full_name"
                                id="full_name"
                                x-model="form.full_name"
                                class="input-field"
                                :class="{ 'border-red-300': errors.full_name }"
                                placeholder="Enter patient's full name"
                                required
                            >
                            <p x-show="errors.full_name" x-text="errors.full_name" class="error-message"></p>
                        </div>

                        <!-- SSN -->
                        <div class="form-group">
                            <label for="ssn" class="label">Egyptian SSN (14 digits) *</label>
                            <input
                                type="text"
                                name="ssn"
                                id="ssn"
                                x-model="form.ssn"
                                @input="validateSSN"
                                class="input-field"
                                :class="{ 'border-red-300': errors.ssn, 'border-green-300': form.ssn && !errors.ssn && form.ssn.length === 14 }"
                                placeholder="12345678901234"
                                maxlength="14"
                                required
                            >
                            <p x-show="errors.ssn" x-text="errors.ssn" class="error-message"></p>
                            <p x-show="form.ssn && !errors.ssn && form.ssn.length === 14" class="success-message">✓ Valid SSN format</p>
                        </div>

                        <!-- Mobile Number -->
                        <div class="form-group">
                            <label for="mobile_number" class="label">Mobile Number (01xxxxxxxxx) *</label>
                            <input
                                type="tel"
                                name="mobile_number"
                                id="mobile_number"
                                x-model="form.mobile_number"
                                @input="validateMobile"
                                class="input-field"
                                :class="{ 'border-red-300': errors.mobile_number, 'border-green-300': form.mobile_number && !errors.mobile_number && isValidMobile(form.mobile_number) }"
                                placeholder="01234567890"
                                maxlength="11"
                                required
                            >
                            <p x-show="errors.mobile_number" x-text="errors.mobile_number" class="error-message"></p>
                            <p x-show="form.mobile_number && !errors.mobile_number && isValidMobile(form.mobile_number)" class="success-message">✓ Valid mobile format</p>
                        </div>

                        <!-- Date of Birth -->
                        <div class="form-group">
                            <label for="date_of_birth" class="label">Date of Birth</label>
                            <input
                                type="date"
                                name="date_of_birth"
                                id="date_of_birth"
                                x-model="form.date_of_birth"
                                @change="calculateAge"
                                class="input-field"
                                :max="new Date().toISOString().split('T')[0]"
                            >
                            <p x-show="calculatedAge" x-text="`Age: ${calculatedAge} years`" class="text-sm text-gray-600 mt-1"></p>
                        </div>

                        <!-- Gender -->
                        <div class="form-group">
                            <label for="gender" class="label">Gender</label>
                            <select
                                name="gender"
                                id="gender"
                                x-model="form.gender"
                                class="input-field"
                            >
                                <option value="">Select gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <!-- Address -->
                        <div class="form-group sm:col-span-2">
                            <label for="address" class="label">Address</label>
                            <textarea
                                name="address"
                                id="address"
                                x-model="form.address"
                                rows="3"
                                class="input-field"
                                placeholder="Enter patient's address"
                            ></textarea>
                        </div>
                    </div>

                    <!-- Emergency Contact Section -->
                    <div class="mt-8 pt-8 border-t border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Emergency Contact (Optional)</h3>
                        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                            <div class="form-group">
                                <label for="emergency_contact_name" class="label">Emergency Contact Name</label>
                                <input
                                    type="text"
                                    name="emergency_contact_name"
                                    id="emergency_contact_name"
                                    x-model="form.emergency_contact_name"
                                    class="input-field"
                                    placeholder="Enter emergency contact name"
                                >
                            </div>

                            <div class="form-group">
                                <label for="emergency_contact_phone" class="label">Emergency Contact Phone</label>
                                <input
                                    type="tel"
                                    name="emergency_contact_phone"
                                    id="emergency_contact_phone"
                                    x-model="form.emergency_contact_phone"
                                    class="input-field"
                                    placeholder="01234567890"
                                >
                            </div>

                            <div class="form-group sm:col-span-2">
                                <label for="emergency_contact_relationship" class="label">Relationship</label>
                                <select
                                    name="emergency_contact_relationship"
                                    id="emergency_contact_relationship"
                                    x-model="form.emergency_contact_relationship"
                                    class="input-field"
                                >
                                    <option value="">Select relationship</option>
                                    <option value="spouse">Spouse</option>
                                    <option value="parent">Parent</option>
                                    <option value="child">Child</option>
                                    <option value="sibling">Sibling</option>
                                    <option value="relative">Other Relative</option>
                                    <option value="friend">Friend</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Medical Information Section -->
                    <div class="mt-8 pt-8 border-t border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Medical Information (Optional)</h3>
                        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                            <div class="form-group">
                                <label for="blood_type" class="label">Blood Type</label>
                                <select
                                    name="blood_type"
                                    id="blood_type"
                                    x-model="form.blood_type"
                                    class="input-field"
                                >
                                    <option value="">Select blood type</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="allergies" class="label">Known Allergies</label>
                                <textarea
                                    name="allergies"
                                    id="allergies"
                                    x-model="form.allergies"
                                    rows="2"
                                    class="input-field"
                                    placeholder="List any known allergies"
                                ></textarea>
                            </div>

                            <div class="form-group sm:col-span-2">
                                <label for="medical_history" class="label">Medical History</label>
                                <textarea
                                    name="medical_history"
                                    id="medical_history"
                                    x-model="form.medical_history"
                                    rows="3"
                                    class="input-field"
                                    placeholder="Brief medical history"
                                ></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="mt-8 pt-6 border-t border-gray-200 flex items-center justify-between">
                        <div class="flex items-center">
                            <input
                                type="checkbox"
                                id="save_draft"
                                x-model="saveDraft"
                                class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"
                            >
                            <label for="save_draft" class="ml-2 block text-sm text-gray-900">
                                Auto-save as draft
                            </label>
                        </div>

                        <div class="flex space-x-3">
                            <button type="button" @click="window.location.href='/patients'" class="btn-secondary">
                                Cancel
                            </button>
                            <button title="Register Patient" type="submit" :disabled="loading || !isFormValid()" class="btn-primary">
                                <span x-show="loading" class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></span>
                                <span x-text="loading ? 'Saving...' : 'Register Patient'"></span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Success/Error Messages -->
            <div x-show="successMessage" x-text="successMessage" class="mt-6 p-4 bg-green-50 border border-green-200 text-green-700 rounded-md fade-in"></div>
            <div x-show="errorMessage" x-text="errorMessage" class="mt-6 p-4 bg-red-50 border border-red-200 text-red-700 rounded-md fade-in"></div>
        </div>
    </main>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('patientRegistration', () => ({
                form: {
                    full_name: '',
                    ssn: '',
                    mobile_number: '',
                    date_of_birth: '',
                    gender: '',
                    address: '',
                    emergency_contact_name: '',
                    emergency_contact_phone: '',
                    emergency_contact_relationship: '',
                    blood_type: '',
                    allergies: '',
                    medical_history: ''
                },
                errors: {},
                loading: false,
                saveDraft: true,
                calculatedAge: null,
                successMessage: '',
                errorMessage: '',
                draftTimer: null,

                init() {
                    // Check for draft data
                    this.loadDraft();
                    
                    // Setup auto-save
                    this.$watch('form', () => {
                        if (this.saveDraft) {
                            this.scheduleDraftSave();
                        }
                    }, { deep: true });
                },

                validateSSN() {
                    const ssn = this.form.ssn.replace(/\D/g, ''); // Remove non-digits
                    this.form.ssn = ssn;
                    
                    if (ssn.length === 0) {
                        delete this.errors.ssn;
                    } else if (ssn.length !== 14) {
                        this.errors.ssn = 'SSN must be exactly 14 digits';
                    } else if (!/^\d{14}$/.test(ssn)) {
                        this.errors.ssn = 'SSN must contain only numbers';
                    } else {
                        delete this.errors.ssn;
                    }
                },

                validateMobile() {
                    const mobile = this.form.mobile_number.replace(/\D/g, ''); // Remove non-digits
                    this.form.mobile_number = mobile;
                    
                    if (mobile.length === 0) {
                        delete this.errors.mobile_number;
                    } else if (!this.isValidMobile(mobile)) {
                        this.errors.mobile_number = 'Mobile must be 11 digits starting with 01[0-2]';
                    } else {
                        delete this.errors.mobile_number;
                    }
                },

                isValidMobile(mobile) {
                    return /^01[0-2]\d{8}$/.test(mobile);
                },

                calculateAge() {
                    if (this.form.date_of_birth) {
                        const birthDate = new Date(this.form.date_of_birth);
                        const today = new Date();
                        let age = today.getFullYear() - birthDate.getFullYear();
                        const monthDiff = today.getMonth() - birthDate.getMonth();
                        
                        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                            age--;
                        }
                        
                        this.calculatedAge = age;
                    } else {
                        this.calculatedAge = null;
                    }
                },

                isFormValid() {
                    return this.form.full_name.trim() && 
                           this.form.ssn.length === 14 && 
                           this.isValidMobile(this.form.mobile_number) &&
                           Object.keys(this.errors).length === 0;
                },

                scheduleDraftSave() {
                    if (this.draftTimer) {
                        clearTimeout(this.draftTimer);
                    }
                    
                    this.draftTimer = setTimeout(() => {
                        this.saveDraftData();
                    }, 2000); // Save after 2 seconds of inactivity
                },

                saveDraftData() {
                    try {
                        localStorage.setItem('patient_registration_draft', JSON.stringify(this.form));
                    } catch (error) {
                        console.error('Failed to save draft:', error);
                    }
                },

                loadDraft() {
                    try {
                        const draft = localStorage.getItem('patient_registration_draft');
                        if (draft) {
                            const draftData = JSON.parse(draft);
                            Object.assign(this.form, draftData);
                            this.calculateAge();
                        }
                    } catch (error) {
                        console.error('Failed to load draft:', error);
                    }
                },

                clearDraft() {
                    try {
                        localStorage.removeItem('patient_registration_draft');
                    } catch (error) {
                        console.error('Failed to clear draft:', error);
                    }
                },

                async submitForm() {
                    // Validate form before submission
                    this.validateSSN();
                    this.validateMobile();
                    
                    if (!this.isFormValid()) {
                        this.errorMessage = 'Please fix validation errors before submitting.';
                        setTimeout(() => this.errorMessage = '', 5000);
                        return;
                    }

                    this.loading = true;
                    this.errorMessage = '';
                    this.successMessage = '';

                    try {
                        const response = await fetch('/api/patients', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                            },
                            body: JSON.stringify(this.form)
                        });

                        if (response.ok) {
                            const patient = await response.json();
                            this.successMessage = 'Patient registered successfully!';
                            this.clearDraft();
                            
                            // Redirect after success
                            setTimeout(() => {
                                window.location.href = `/patients/${patient.ssn}`;
                            }, 2000);
                        } else if (response.status === 401) {
                            window.location.href = '/login';
                        } else {
                            const errorData = await response.json();
                            this.errorMessage = errorData.detail || 'Failed to register patient. Please try again.';
                        }
                    } catch (error) {
                        console.error('Registration error:', error);
                        this.errorMessage = 'Network error. Please check your connection and try again.';
                    } finally {
                        this.loading = false;
                    }
                }
            }));
        });
    </script>
</body>
</html>